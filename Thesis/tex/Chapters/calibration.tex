% Chapter 1

\chapter{Parameter tuning} % Main chapter title

\lhead{Chapter XXX. \emph{XXX}} % This is for the header on each page - perhaps a shortened title
	
%----------------------------------------------------------------------------------------

The model has several parameters which must be selected carefully before the simulation can be used to infer knowledge about market behavior. 

The parameter tuning turned out to consume a significant amount of time, and simple using a genetic algorithm to optimize over the entire space of parameters was not enough. Instead, the process was a slow and iterative one of running the genetic algorithm to create a data set, analyze the data set to find out what was discovered in the search, and then run the genetic algorithm again with different parameters. Thus several data sets were created, each with the purpose of examining some aspect of the simulation, or of the parameter tuning method itself. 

This chapter will cover the instruments used in the optimization of the model parameters, and also mention the machine learning tools used in the analysis of the data sets. 

The parameter tuning has two overall goals, which are covered in the following section.

\section{Motivation and overall procedure}
First of all, the model must be calibrated such that it mimics the behavior of real markets. Since virtually every aspect of the simulation behavior depends on the values on the various parameters, these must be chosen carefully in order for the simulation to produce realistic behavior. An example of a simulation untuned parameters causing  unrealistic behavior is given in figure \ref{subfig:unrealistic_behavior}. Selecting realistic parameters is by far a simple task. First of all, it requires a way of quantifying the quality of each simulation. The choice of such a quantification is discussed in section \ref{section:simulation_fitness}. Secondly, there might be several different parameter configurations which produce seemingly realistic behavior, but do not correspond to a realistic market setting. An example for this is given in figure \ref{subfig:unrealistic_parameters}, and section \ref{section:filtering_parameters} briefly discusses this point. 

\begin{figure}
	%issue 15
	\subcaptionbox{Parameters causing unrealistic dynamics\label{subfig:unrealistic_behavior}}
	[0.49\linewidth]{\includegraphics[width=0.5\textwidth]{Electron.pdf}}
	\subcaptionbox{Unrealistic parameters causing realistic dynamics\label{subfig:unrealistic_parameters}}
	[0.49\linewidth]{\includegraphics[width=0.5\textwidth]{Electron.pdf}}
	\caption{\textbf{Motivatoin for tuning:} the two}\label{fig:tuning_motivation}
\end{figure}

The second goal of the parameter tuning is to find parameters which promotes certain desirable behaviors. For instance, we might be interested in determining which parameters causes the traded price to stabilize faster after a shock to the fundamental price. Metrics for doing this is discussed in section \ref{section:simulation_fitness}

The selection of parameters is a fairly complicated process because of the large parameter space, and because it takes a significant time to evaluate the fitness of a given set of parameters\footnote{The calculation time depends largely on the parameters, such as the number of agents and how active these are. Typically one to several minutes are required to evaluate a single set of parameters.}. amount of time to execute a simulation. Because of this, the following three-step parameter selection procedure was used.
\begin{enumerate}
	\item Fix some of the model parameters in order to reduce the search space for the optimization algorithm. This requires us to consider which parameters can be fixed without losing opportunity to gain insight into market behavior. Essentially this step is a question of prioritizing the optimization of some parameters over the optimization of others. 
	\item Use an optimization algorithm to find sets of parameters which yield realistic model behavior. A genetic algorithm was chosen for this purpose, and the details are explained in section \ref{section:genetic_algorithm}.
	\item From the set of parameter combinations found by the optimization algorithm, remove the parameter combinations which obviously do not correspond to a realistic setting.
\end{enumerate}

\subsection{Selecting fixed parameters}
The main parameters of interest are the ones that control the latency and speed of the agents. The agent strategy parameters are less important, since 



\begin{description}
	%issue 16
	\item [\nrounds] Due to the computational cost of running the simulation for a large number of rounds, the the number of rounds is fixed at $10^5$ for all experiments.
	\item [Order volumes] As with most of the other agent parameters, the 
\end{description}

The remaining model parameters will either be fixed for each experiment, or varied by the genetic algorithm. 

\subsection{Filtering parameters}\label{section:filtering_parameters}
As mentioned earlier, it is not enough simply to define a fitness function which assigns high values to parameters causing realistic behavior. In addition, it is important to discard parameters which obviously do not correspond to a realistic setting. Imagine that the simulation scores high fitness values when executed without any market makers. Since it is known that real markets do in fact contain market makers, nothing can be inferred from such a result. Indeed this might be a consequence of poorly designed fitness measures, but since it is easier to use domain specific knowledge to filter out the unrealistic parameters

\begin{figure}[htbp]
	\centering
		\includegraphics{Figures/Electron.pdf}
		\rule{35em}{0.5pt}
	\caption{Example of a simulation which is assigned fairly good fitness values, but which was executed with clearly unrealistic parameters: $\nmm = \nsc = 0$. The simulation reaches the new fundamental price fairly quickly without any undershoot, and stays within the stability margin. The only point where it scores badly is the standard deviation which is slightly high due to the fluctuating trade price.}
	\label{fig:no_marketmakers}
\end{figure}



\section{Inverse simulation with a genetic algorithm}\label{section:genetic_algorithm}
%issue 5
A basic type of genetic algorithm was used. The algorithm proceeds as explain below.
\begin{enumerate}
	\item Generate a population of healthy individuals, e.g., individuals with valid parameters.
	\item Evaluate fitness for every individual in the population.
	\item Repeat $n_\text{gen}$ times 
	\begin{enumerate}
		\item Generate offspring by crossing existing individuals.
		\item Apply mutation to with a certain probability to each individual (parents as well as children)
		\item Evaluate fitness of children and mutated parents.
	\end{enumerate}
\end{enumerate}
Table \ref{table:genetic_algorithm_parameters} presents an overview of the parameters used in the genetic algorithm. 

\begin{table}
	\centering
	\begin{tabular}{l|l}
		Parameter & Assignment\\\hline
		Number of generations & 200 to 1000\\
		Number of individuals & 100 to 1000\\
		Cross-over points & 2\\
		Tournament size & 3\\
		Mutation probability & 0.1\\
		Mutation distribution &  $\mathcal{N}(\mu = 0, \sigma = 0.1)$\\
	\end{tabular}
	\caption{Overview of parameters used in the genetic algorithm}
	\label{table:genetic_algorithm_parameters}
\end{table}

\subsection{Representing parameters as genes}
A set of parameters is represented by an individual, $i$, consisting of one floating point $g_{i,j}$ number for each parameter, where $j$ denotes the index of the parameter. When the population is initialized, each $g_{i,j}$ is drawn from a uniform distributed in the range $g_j \in [0;1]$:
\begin{equation}
g_{i,j} \mathcal{U}(0,1)
\end{equation}
Most of the parameters in the model are integers



%issue 17


\subsection{Model fitness}\label{section:simulation_fitness}

In order to use inverse simulation, it is necessary to decide on how to measure the quality of an instance of the simulation. 
In this work, the overall goal is to examine which parameter values cause the market to be stable, and which cause it to be unstable. 
Another interesting point is the speed with which the market responds to the shock to the fundamental price, and which parameters influence this property. Furthermore, we are interested in investigating whether or not 

\begin{itemize}
\item 
\item Are there certain parameter combinations which cause the market to behave in certain ways. S
\end{itemize}
In particular the parameters controlling various time delays are of interest. 
The search space of the parameters is very large, which makes an exhaustive search impossible.
To this end, four fitness measures were defined.
The balance between the number 
Several parameters influence the number of orders submitted by the high frequency traders.



\section{Controlling market behavior}
Inverse simulation is a handy tool, because it makes it possible to specify desired behavior, and then search for parameters yielding such behavior. The four fitness measures defined in section \ref{section:simulation_fitness} gives 16 combinatinos for how to optimize the model. 

First of all, we are interested in establishing which parameters cause the market to return to a stable state after the fundamental price has incurred a shock

\begin{table}
\begin{tabular}{c|c}
\textbf{Parameter} & \textbf{Range}\\
\nmm & \\
\nsc & 
\end{tabular}
\caption{Overview of experiments}
\label{table:optimization_goals}
\end{table}

\section{Experiments}
This section will outline the varioius experiments carried out with the fundamental. 


\begin{figure}[htbp]
%issue 18
	\centering
		\includegraphics{Figures/Electron.pdf}
		\rule{35em}{0.5pt}
	\caption{}
	\label{fig:}
\end{figure}





\section{Data sets and analysis}
The previous sections contain the details of each of the steps undertaken in order to produce data sets. To summarize, the list below enumerates the steps.
\begin{enumerate}
\item Initialize a population in the genetic algorithm with healthy individuals.
\item Evaluate the fitness for every individual several times and obtain fitness-values by calculating averages.
\item Stack all individuals that ever lived into a $\datasetNpoints \times \individuallength$ parameter data matrix \datamatrixpar, where $\datasetNpoints$ is the number of individuals, and $\individuallength$ is the length of each individual. Likewise, stack the fitness values into a $\datasetNpoints \times \fitnesslength$ fitness-data matrix \datamatrixfit, where \fitnesslength is the number of fitness values calculated. 
\item Filter the data by removing rows in \datamatrixpar with parameters which can be deemed not to correspond to real markets, and by removing rows in \datamatrixfit with fitness values that are not realistic. Please refer to section \ref{section:filtering_parameters} for details. Naturally, when a row is removed in \datamatrixpar, it is also removed in \datamatrixfit, and vice versa. 
\item 
\end{enumerate}

\begin{table}
\centering
\scriptsize
\input{Tables/example_dataset_parameters.tex}
\caption{An example data matrix containing the parameters of ten individuals who lived sometime during the execution of the genetic algorithm. In this case, each individual contained paremeters for the number of HFT agents, as well as the latency and thinking time parameters. Hence, the data matrix has a column for each.}
\label{table:example_dataset_parameters}
\end{table}

\begin{table}
\centering
\input{Tables/example_dataset_fitnesses.tex}
\caption{This table contains the fitness values for each individual in table \ref{table:example_dataset_parameters}. Note that, in order to increase the reliability of the fitness measure of an individual, the recorded fitness-values are the average of the fitness-values obtained by evaluating each individual ten times}
\label{table:example_dataset_fitnesses}
\end{table}

